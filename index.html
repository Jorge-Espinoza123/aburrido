<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Reconocimiento de N√∫meros</title>

    <!-- Librer√≠as necesarias -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.1/fabric.min.js"></script>

    <style>
      body {
        text-align: center;
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
      }
      h1 { margin-top: 20px; }
      #bigcanvas {
        border: 2px solid #333;
        margin-top: 20px;
        background: white;
      }
      button {
        margin: 10px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      #resultado {
        font-size: 40px;
        margin-top: 20px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Dibuja un n√∫mero (0‚Äì9)</h1>

    <canvas id="bigcanvas" width="200" height="200"></canvas><br>
    <button onclick="limpiar()">üßπ Limpiar</button>
    <button id="btnPredecir" onclick="predecir()" disabled>üîç Predecir</button>

    <div id="resultado"></div>
    <canvas id="smallcanvas" width="28" height="28" style="display:none"></canvas>

    <script src="drawing.js"></script>

    <script>
      let modelo = null;

      // Cargar modelo
      async function cargarModelo() {
        console.log("Cargando modelo...");
        modelo = await tf.loadLayersModel("model.json");
        console.log("‚úÖ Modelo cargado");
        document.getElementById("btnPredecir").disabled = false;
      }
      cargarModelo();

      // Redimensionar el dibujo a 28x28
      function resample_single(canvas, width, height, resize_canvas) {
        let ctx = resize_canvas.getContext("2d");
        ctx.drawImage(canvas, 0, 0, width, height);
      }

      // Predecir el n√∫mero dibujado
      function predecir() {
        if (!modelo) {
          alert("El modelo a√∫n no se ha cargado üòÖ");
          return;
        }

        const small = document.getElementById("smallcanvas");
        const ctxSmall = small.getContext("2d");
        const big = document.getElementById("bigcanvas");

        // Convertir el lienzo a 28x28
        resample_single(big, 28, 28, small);
        const imgData = ctxSmall.getImageData(0, 0, 28, 28);

        let arr = [];
        for (let i = 0; i < 28; i++) {
          let row = [];
          for (let j = 0; j < 28; j++) {
            const pos = (i * 28 + j) * 4;
            const val = imgData.data[pos + 3] / 255; // alpha ‚Üí escala 0‚Äì1
            row.push([val]);
          }
          arr.push(row);
        }

        // Crear tensor con forma correcta [1, 28, 28, 1]
        const tensor = tf.tensor4d([arr], [1, 28, 28, 1]);
        const prediccion = modelo.predict(tensor).dataSync();
        const numero = prediccion.indexOf(Math.max(...prediccion));

        document.getElementById("resultado").innerText = "Predicci√≥n: " + numero;
      }
    </script>
  </body>
</html>
