<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reconocimiento de N√∫meros</title>

  <!-- ‚úÖ Librer√≠as necesarias -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fabric@4.6.0/dist/fabric.min.js"></script>

  <style>
    body {
      text-align: center;
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
    }
    h1 {
      margin-top: 20px;
    }
    #bigcanvas {
      border: 2px solid #000;
      margin-top: 20px;
      background: white;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #0056b3;
    }
    #resultado {
      font-size: 32px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Dibuja un n√∫mero (0‚Äì9)</h1>

  <!-- üé® √Årea para dibujar -->
  <canvas id="bigcanvas" width="200" height="200"></canvas><br>

  <button onclick="limpiar()">üßπ Limpiar</button>
  <button id="btnPredecir" onclick="predecir()" disabled>üîç Predecir</button>

  <div id="resultado"></div>

  <!-- Canvas oculto para redimensionar a 28x28 -->
  <canvas id="smallcanvas" width="28" height="28" style="display:none"></canvas>

  <!-- üñäÔ∏è Script de dibujo -->
  <script>
    let canvas;

    window.addEventListener("load", () => {
      // Crear pizarra de dibujo
      canvas = new fabric.Canvas("bigcanvas");
      canvas.isDrawingMode = true;

      canvas.freeDrawingBrush.width = 15;
      canvas.freeDrawingBrush.color = "black";
      canvas.setBackgroundColor("white", canvas.renderAll.bind(canvas));

      console.log("üñäÔ∏è Listo para dibujar!");
    });

    function limpiar() {
      canvas.clear();
      canvas.setBackgroundColor("white", canvas.renderAll.bind(canvas));
    }
  </script>

  <!-- ü§ñ Script de predicci√≥n -->
  <script>
    let modelo = null;

    async function cargarModelo() {
      console.log("Cargando modelo...");
      try {
        modelo = await tf.loadLayersModel("model.json");
        console.log("‚úÖ Modelo cargado correctamente");
        document.getElementById("btnPredecir").disabled = false;
      } catch (error) {
        console.error("‚ùå Error al cargar el modelo:", error);
      }
    }
    cargarModelo();

    function resample_single(canvas, width, height, resize_canvas) {
      const ctx = resize_canvas.getContext("2d");
      ctx.drawImage(canvas, 0, 0, width, height);
    }

    function predecir() {
      if (!modelo) {
        alert("El modelo a√∫n no se ha cargado üòÖ");
        return;
      }

      const small = document.getElementById("smallcanvas");
      const ctxSmall = small.getContext("2d");
      const big = document.getElementById("bigcanvas");

      // Redimensionar el dibujo a 28x28
      resample_single(big, 28, 28, small);
      const imgData = ctxSmall.getImageData(0, 0, 28, 28);

      // Procesar la imagen en blanco y negro
      let arr = [];
      for (let i = 0; i < 28; i++) {
        let row = [];
        for (let j = 0; j < 28; j++) {
          const pos = (i * 28 + j) * 4;
          const val = imgData.data[pos + 3] / 255; // canal alpha (transparencia)
          row.push([val]);
        }
        arr.push(row);
      }

      // Convertir a tensor
      const tensor = tf.tensor4d([arr], [1, 28, 28, 1]);
      const prediccion = modelo.predict(tensor).dataSync();
      const numero = prediccion.indexOf(Math.max(...prediccion));

      document.getElementById("resultado").innerText = "Predicci√≥n: " + numero;
    }
  </script>
</body>
</html>


